name: Deploy to VPS Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H 45.13.132.251 >> ~/.ssh/known_hosts

      - name: Deploy to Server
        env:
          DEPLOY_PATH: /home/RoomSpa
          DEPLOY_HOST: 45.13.132.251
          DEPLOY_USER: root
          GITHUB_USERNAME: RitikChahar
          GITHUB_REPO: RoomSpa
          GITHUB_TOKEN: ${{ secrets.DEPLOY_GITHUB_TOKEN }}
        run: |
          # Pass environment variables to the SSH session
          ssh $DEPLOY_USER@$DEPLOY_HOST "
            export DEPLOY_PATH='$DEPLOY_PATH'
            export GITHUB_USERNAME='$GITHUB_USERNAME'
            export GITHUB_REPO='$GITHUB_REPO'
            export GITHUB_TOKEN='$GITHUB_TOKEN'
            
            # Create directory if it doesn't exist
            mkdir -p '$DEPLOY_PATH'
            
            # Initialize git repository if it doesn't exist
            cd '$DEPLOY_PATH'
            if [ ! -d .git ]; then
              git init
              git remote add origin https://$GITHUB_USERNAME:$GITHUB_TOKEN@github.com/$GITHUB_USERNAME/$GITHUB_REPO.git
            else
              git remote set-url origin https://$GITHUB_USERNAME:$GITHUB_TOKEN@github.com/$GITHUB_USERNAME/$GITHUB_REPO.git
            fi

            # Fetch and reset to match remote
            git fetch origin main
            git reset --hard origin/main

            # Continue with deployment...
            if [ ! -f "docker-compose.prod.yml" ]; then
              echo 'âŒ Error: docker-compose.prod.yml not found'
              exit 1
            fi

            # Stop existing containers FIRST to free up port 80
            echo 'ðŸ›‘ Stopping existing containers...'
            docker-compose -f docker-compose.prod.yml down || true
            
            # Wait a moment for ports to be released
            sleep 5

            # SSL Certificate Setup with Certbot (after stopping containers)
            echo 'ðŸ”’ Checking/Updating SSL certificates...'
            certbot certonly --standalone -d spa.manishdashsharma.site --non-interactive --agree-tos -m roomsparevo@gmail.com || { 
              echo 'âš ï¸ Certbot failed, trying webroot method...'
              # Alternative: Use webroot method if standalone fails
              certbot certonly --webroot -w /var/www/html -d spa.manishdashsharma.site --non-interactive --agree-tos -m roomsparevo@gmail.com || {
                echo 'âš ï¸ SSL certificate update failed, continuing with existing certificates...'
              }
            }

            # Build and deploy with Docker Compose
            echo 'ðŸ—ï¸ Building and deploying with Docker Compose...'
            docker-compose --env-file .env.production -f docker-compose.prod.yml up -d --build || { echo 'âŒ Docker Compose failed'; exit 1; }

            # Clean up old Docker resources
            echo 'ðŸ§¹ Cleaning up Docker resources...'
            docker system prune -f || { echo 'âš ï¸ Docker prune failed'; exit 1; }

            echo 'âœ¨ Deployment completed successfully!'
          "

      - name: Verify Deployment
        run: |
          echo "â³ Waiting for services to start..."
          sleep 15  # Increased wait time for SSL setup
          
          # Check if services are responding
          echo "ðŸ” Verifying service availability..."
          curl -f -s -S --retry 3 --retry-delay 5 http://45.13.132.251:8000 || {
            echo "âŒ Service verification failed"
            exit 1
          }

      - name: Stream Initial Logs
        env:
          DEPLOY_HOST: 45.13.132.251
          DEPLOY_USER: root
        run: |
          echo "ðŸ“„ Streaming server container logs (last 100 lines)..."
          ssh $DEPLOY_USER@$DEPLOY_HOST "docker logs server --tail 100"
          
          echo "ðŸ“„ Checking for any errors in logs..."
          ERROR_COUNT=$(ssh $DEPLOY_USER@$DEPLOY_HOST "docker logs server 2>&1 | grep -i error | wc -l")
          WARNING_COUNT=$(ssh $DEPLOY_USER@$DEPLOY_HOST "docker logs server 2>&1 | grep -i warning | wc -l")
          
          echo "âš ï¸ Found $WARNING_COUNT warnings and $ERROR_COUNT errors in logs"
          
          if [ $ERROR_COUNT -gt 0 ]; then
            echo "ðŸ“„ Showing error details..."
            ssh $DEPLOY_USER@$DEPLOY_HOST "docker logs server 2>&1 | grep -i error"
          fi
          
          echo "âœ… Log streaming completed"